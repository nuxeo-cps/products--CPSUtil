#!/usr/bin/python
#
# (C) Copyright 2005-2007 Nuxeo SAS <http://nuxeo.com>
# Authors:
# M.-A. Darche <madarche@nuxeo.com>
# Olivier Grisel <og@nuxeo.com>
# Julien Anguenot <ja@nuxeo.com>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License version 2 as published
# by the Free Software Foundation.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA
# 02111-1307, USA.
#
# $Id$
"""A script to perform various housekeeping tasks on CPS by calling Zope through
HTTPS and optionally.

This script should be used directly on the server running Zope.

Place this script in /etc/cron.daily/, /etc/cron.weekly/, /etc/cron.monthly/
depending on your needs.

Or you can make it called through an entry in /etc/crontab or through the
"crontab -e" command.

Starts the cpshousekeeping script every night at 03h59:
59 3 * * * /usr/local/bin/cpshousekeeping -vrlPb -u admin -w 'xxx' --host localhost -p 8080 -i cps -z /usr/local/zope/instance/cps/var/Data.fs -k /var/backups/zodb/www.mysite.net > /dev/null 2>&1
"""

import sys
import os
import base64
import urllib2
import re
from time import strftime, gmtime
from optparse import OptionParser

DEFAULT_HOST_NAME = 'localhost'
DEFAULT_HOST_PORT = 8080
DEFAULT_INSTANCE_ID = 'cps'
DEFAULT_USER_NAME = 'admin'
DEFAULT_USER_PASSWORD = 'admin'
DEFAULT_HISTORY_DAYS = 0
DEFAULT_ZODB_PATH = '/usr/local/zope/instance/cps/var/Data.fs'
DEFAULT_ZODB_BACKUP_DIR_PATH = '/var/backups/zodb'
DEFAULT_ZODB_BACKUPS_KEEP_COUNT = 7
DEFAULT_NOTIFICATION_FREQ = None

ZODB_PACKING_URL_PATTERN = 'http://%s:%s/Control_Panel/Database/manage_pack?days:float=%d'
PURGE_LOCALROLES_URL_PATTERN = "http://%s:%s/%s/portal_membership/manage_purgeLocalRoles"
PURGE_REPOSITORY_URL_PATTERN = "http://%s:%s/%s/portal_repository/manage_purgeDeletedRevisions"
CPS_LOGIN_URL_PATTERN = "http://%s:%s/%s/logged_in"
TIME_FORMAT = '%Y-%m-%d_%H:%M'
ZODB_BACKUP_FILENAME_REGEXP = re.compile(r'\d+-\d{2}-\d{2}_\d{2}:\d{2}-.+')
SEND_NOTIFICATIONS_PATTERN = "http://%s:%s/%s/cps_subscriptions_schedule_notifications?subscription_mode=%s"


def execArgs():
    """Analyze command line arguments.
    """
    usage = "usage: %prog [options]"
    parser = OptionParser(usage=usage)

    parser.add_option('-v', '--verbose',
                      action='store_true',
                      dest='verbose',
                      default=False,
                      help="Print additional information to stdout.")

    parser.add_option('-n', '--host',
                      action='store',
                      dest='host_name',
                      type='string',
                      metavar='NAME',
                      default=DEFAULT_HOST_NAME,
                      help="Use NAME for the server to connect to. "
                      "Defaults to %s" % DEFAULT_HOST_NAME)

    parser.add_option('-p', '--port',
                      action='store',
                      dest='host_port',
                      type='int',
                      metavar='NUMBER',
                      default=DEFAULT_HOST_PORT,
                      help="Use NUMBER for the server port to use. "
                      "Defaults to %s" % DEFAULT_HOST_PORT)

    parser.add_option('-i', '--instance-id',
                      action='store',
                      dest='instance_id',
                      type='string',
                      metavar='ID',
                      default=DEFAULT_INSTANCE_ID,
                      help="Use ID for CPS instance id to use. "
                      "Defaults to %s" % DEFAULT_INSTANCE_ID)

    parser.add_option('-u', '--user',
                      action='store',
                      dest='user_name',
                      type='string',
                      metavar='NAME',
                      default=DEFAULT_USER_NAME,
                      help="Use NAME for the user name to Zope. "
                      "Defaults to '%s'" % DEFAULT_USER_NAME)

    parser.add_option('-w', '--password',
                      action='store',
                      dest='user_password',
                      type='string',
                      metavar='PASSWORD',
                      default=DEFAULT_USER_PASSWORD,
                      help="Use PASSWORD for the password to Zope. "
                      "Defaults to '%s'" % DEFAULT_USER_PASSWORD)

    parser.add_option('-r', '--purge-repository',
                      action='store_true',
                      dest='purge_repository',
                      default=False,
                      help="Purge the repository to remove orphan documents")

    parser.add_option('-l', '--purge-localroles',
                      action='store_true',
                      dest='purge_localroles',
                      default=False,
                      help="Clean the localroles of deleted members")

    parser.add_option('-P', '--pack-zodb',
                      action='store_true',
                      dest='pack_zodb',
                      default=False,
                      help="Pack the ZODB")

    parser.add_option('-d', '--days',
                      action='store',
                      dest='days',
                      type='float',
                      metavar='NUMBER',
                      default=DEFAULT_HISTORY_DAYS,
                      help="Use NUMBER for the days to keep in history. "
                      "Defaults to %s" % DEFAULT_HISTORY_DAYS)

    parser.add_option('-z', '--zodbfile',
                      action='store',
                      dest='zodbfile_path',
                      type='string',
                      metavar='FILE',
                      default=DEFAULT_ZODB_PATH,
                      help="The FILE path to the ZODB. "
                      "The default is %s" % DEFAULT_ZODB_PATH)

    parser.add_option('-b', '--backup',
                      action='store_true',
                      dest='backup',
                      default=False,
                      help="Backup the ZODB that has just been packed "
                           """using the "cp" command.""")

    parser.add_option('-k', '--backupdir',
                      action='store',
                      dest='backupdir_path',
                      type='string',
                      metavar='FILE',
                      default=DEFAULT_ZODB_BACKUP_DIR_PATH,
                      help="The FILE path of the directory used for storing "
                      "ZODB backups. "
                      "The default is %s" % DEFAULT_ZODB_BACKUP_DIR_PATH)

    parser.add_option('-B', '--keep-backups-count',
                      action='store',
                      dest='backups_keep_count',
                      type='int',
                      metavar='NUMBER',
                      default=DEFAULT_ZODB_BACKUPS_KEEP_COUNT,
                      help="The NUMBER of ZODB backups to keep. "
                      "The default is %s" % DEFAULT_ZODB_BACKUPS_KEEP_COUNT)

    parser.add_option('-s', '--send-notifications',
                      action='store',
                      dest='notifications',
                      type='choice',
                      metavar='FREQ',
                      choices=['daily','weekly', 'monthly'],
                      default=DEFAULT_NOTIFICATION_FREQ,
                      help="Send email notifications of frequence FREQ of "
                      "[daily|weekly|monthly]. Defaults to %s " %
                      str(DEFAULT_NOTIFICATION_FREQ))

    (options, args) = parser.parse_args()
    global verbose
    verbose = options.verbose

    if options.purge_repository:
        log("Purging the document repository of host %s ..." %
            options.host_name)
        url = PURGE_REPOSITORY_URL_PATTERN % (options.host_name,
                                              options.host_port,
                                              options.instance_id)
        call_url(url, options.user_name, options.user_password)
        log("Successfully purged repository of host %s" % options.host_name)

    if options.purge_localroles:
        log("Purging the local roles of host %s ..." % options.host_name)
        url = PURGE_LOCALROLES_URL_PATTERN % (options.host_name,
                                              options.host_port,
                                              options.instance_id)
        call_url(url, options.user_name, options.user_password)
        log("Successfully purged localroles of host %s" % options.host_name)

    if options.notifications:
        log("Sending notifications of host %s ..." % options.host_name)
        url = SEND_NOTIFICATIONS_PATTERN % (options.host_name,
                                            options.host_port,
                                            options.instance_id,
                                            options.notifications)
        call_url(url, options.user_name, options.user_password)
        log("Successfully sent notifications of host %s" % options.host_name)

    if options.pack_zodb:
        packZodb(options.zodbfile_path, options.days,
                 options.host_name, options.host_port,
                 options.user_name, options.user_password)

    if options.backup:
        backupZodb(options.zodbfile_path, options.backupdir_path,
                   options.backups_keep_count)


def packZodb(zodb_path, days, host_name, host_port, user_name, user_password):
    log("Trying to pack the ZODB %s of host %s ..." % (zodb_path, host_name))
    if verbose:
        zodb_size = os.path.getsize(zodb_path)
        log("ZODB size is %s" % getHumanReadableSize(zodb_size))
    url = ZODB_PACKING_URL_PATTERN % (host_name, host_port, days)
    call_url(url, user_name, user_password)
    log("Successfully packed ZODB of host %s" % host_name)
    if verbose:
        zodb_size = os.path.getsize(zodb_path)
        log("ZODB size now is %s" % getHumanReadableSize(zodb_size))

def backupZodb(zodb_path, backupdir_path, backups_keep_count=0):
    log("Checking for backups ...")
    time_string = strftime(TIME_FORMAT, gmtime())
    file_name = '%s-%s' % (time_string, os.path.basename(zodb_path))
    zodb_backup_path = os.path.join(backupdir_path, file_name)
    command = "cp -p %s %s" % (zodb_path, zodb_backup_path)
    log("command = %s" % command)
    os.system(command)
    if backups_keep_count > 0:
        log("There are some backups to remove ...")
        file_names = os.listdir(backupdir_path)
        file_names = [x for x in file_names
                      if ZODB_BACKUP_FILENAME_REGEXP.match(x)]
        file_names.sort()
        file_names_to_delete = file_names[:-backups_keep_count]
        for file_name in file_names_to_delete:
            file_path = os.path.join(backupdir_path, file_name)
            log("Removing = %s ..." % file_path)
            os.remove(file_path)
    log("Successful backup of the ZODB")


def call_url(url, username, password):
    """Call urllib2.urlopen with forced HTTP Basic Auth header.
    """
    request = urllib2.Request(url)
    base64string = base64.encodestring('%s:%s' % (username, password))[:-1]
    request.add_header("Authorization", "Basic %s" % base64string)
    try:
        urllib2.urlopen(request)
    except urllib2.HTTPError, e:
        if e.code == 401:
            log('Invalid credentials on %s, aborting' % url, True)

        elif e.code == 400:
            # XXX: manage_purgeLocalRoles returns code 400
            return
        else:
            log('Error %d on %s, aborting' % (e.code, url), True)
        sys.exit(1)
    except IOError:
        log('Unable to open %s, aborting' % url, True)
        sys.exit(1)


def getHumanReadableSize(octet_size):
    """Returns a string that is a human readable file size.
    """
    mega = 1024*1024
    kilo = 1024

    if octet_size is None or octet_size <= 0:
        return "0"
    elif octet_size >= mega:
        if octet_size == mega:
            return "1M"
        else:
            msize = float(octet_size/float(mega))
            msize = float('%.02f' % msize)
            return "%sM" % msize
    elif octet_size >= kilo:

        if octet_size == kilo:
            return "1K"
        else:
            ksize = float(octet_size/float(kilo))
            ksize = float('%.02f' % ksize)
            return "%sK" % ksize
    else:
        return str(octet_size)


def getSpaceLeftOnDevice():
    """TODO
    $ df -h | grep '^/dev/' | awk '{print $4}'
    """
    pass


def log(message, force=False):
    """Log the given message to stderr.
    """
    if force or verbose:
        print >> sys.stderr, message


# Shell conversion
if __name__ == '__main__':
    execArgs()

